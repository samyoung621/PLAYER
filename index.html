<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£’çƒéšŠå“¡æ•¸æ“šçµ±è¨ˆèˆ‡ç…§ç‰‡ (æœ€çµ‚ç©©å®šç‰ˆ)</title>
    <link href="//cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ç¢ºä¿æ‰€æœ‰å–®å…ƒæ ¼å…§å®¹ç½®ä¸­å°é½Š */
        #stats-table th, #stats-table td { text-align: center; }
        .player-photo { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; }
        .player-name-link { cursor: pointer; font-weight: bold; color: #0d6efd; }
        .player-name-link:hover { text-decoration: underline; }
        #modalPlayerPhoto { border: 5px solid #0d6efd; }
        
        /* ============== å‡çµæ¬„ä½ CSS ============== */
        #stats-table th, #stats-table td { 
            position: sticky; 
            background-color: white; 
            z-index: 1; 
        }
        .sticky-col-1 { left: 0; z-index: 2; min-width: 60px; } 
        .sticky-col-2 { left: 60px; z-index: 2; min-width: 70px; } 
        .sticky-col-3 { left: 130px; z-index: 2; min-width: 150px; } 

        #stats-table th.sticky-col-1, #stats-table th.sticky-col-2, #stats-table th.sticky-col-3 { background-color: #e9ecef; } 

        /* é«˜äº®é¡¯ç¤ºæœ€é«˜åˆ†æ•¸ (å„²å­˜æ ¼èƒŒæ™¯è‰²) */
        .highlight { 
            background-color: #ffc107; 
            font-weight: bold; 
            color: #333; 
        }

        /* ç…§ç‰‡æ¨£å¼é«˜äº®æ–°å¢ (æ‡‰ç”¨æ–¼å„²å­˜æ ¼å…§ç…§ç‰‡) */
        .best-player-photo {
            border: 3px solid #dc3545; /* ä½¿ç”¨ç´…è‰²é‚Šæ¡†æ¨™ç¤ºç‚ºç•¶å‰è¡¨æ ¼çš„æœ€é«˜åˆ†çƒå“¡ */
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.7);
        }
        /* æ’åºåœ–ç¤º */
        .sortable { cursor: pointer; }
    </style>
</head>
<body>

<div class="container-fluid my-5">
    <h1 class="text-center mb-4">âš¾ æ£’çƒçƒå“¡æ•¸æ“šçµ±è¨ˆèˆ‡ç…§ç‰‡ ğŸ“Š</h1>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" id="stats-table"> 
            <thead><tr></tr></thead>
            <tbody id="stats-table-body">
                <tr><td colspan="100" class="text-center text-muted">æ­£åœ¨è¼‰å…¥æ•¸æ“šï¼Œè«‹ç¨å€™...</td></tr>
            </tbody>
        </table>
    </div>
    
    <p class="text-end text-muted mt-3">æ•¸æ“šä¾†æºï¼šGoogle Sheet CSV</p>
</div>

<div class="modal fade" id="playerModal" tabindex="-1" aria-labelledby="playerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="playerModalLabel">çƒå“¡è©³ç´°è³‡æ–™</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img id="modalPlayerPhoto" src="" alt="çƒå“¡å€‹äººç…§ç‰‡" class="img-fluid rounded-circle mb-3" style="max-height: 250px; width: auto;">
                        <h4 id="modalPlayerName"></h4>
                    </div>
                    <div class="col-md-8">
                        <h5 class="mb-3 border-bottom pb-2">å®Œæ•´æ•¸æ“šä¸€è¦½</h5>
                        <div id="modalPlayerStats" class="row"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script src="//cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script> 

<script>
    // =======================================================
    // #ç¨‹å¼ç¢¼æ ¸å¿ƒè¨­å®š
    // =======================================================
    // æ‚¨çš„æ•¸æ“šé€£çµ
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/13ZRWxv4aLHLzmSzYEgVttZJIyn3ztmO1g-hL3jfXeNg/export?format=csv&gid=0';
    
    // æ¬„ä½åç¨±
    const JERSEY_COLUMN = 'èƒŒè™Ÿ';       
    const PHOTO_URL_COLUMN = 'ç…§ç‰‡'; 
    const NAME_COLUMN = 'å§“å';         
    const OBP_COLUMN = 'ä¸Šå£˜ç‡';          
    const SLG_COLUMN = 'é•·æ‰“ç‡';           
    
    const OPS_COLUMN_NAME = 'OPS'; 
    const FROZEN_COLUMNS = [PHOTO_URL_COLUMN, JERSEY_COLUMN, NAME_COLUMN]; 
    
    let allPlayerStats = []; 
    let sortColumn = NAME_COLUMN;
    let sortDirection = 'asc';
    let maxValues = {}; 

    // --- ( processData å‡½æ•¸ï¼šè¨ˆç®— OPS å’Œæ‰¾å‡ºæœ€é«˜åˆ† ) ---
    function processData(data) {
        if (data.length === 0) return data;

        data.forEach(player => {
            const obp = parseFloat(player[OBP_COLUMN]) || 0;
            const slg = parseFloat(player[SLG_COLUMN]) || 0;
            player[OPS_COLUMN_NAME] = (obp + slg).toFixed(3); 
        });

        const numericalHeaders = Object.keys(data[0]).filter(header => {
            return !FROZEN_COLUMNS.includes(header) &&
                   header.toUpperCase() !== 'TOTAL' && 
                   header !== OBP_COLUMN &&
                   header !== SLG_COLUMN &&
                   !isNaN(parseFloat(data[0][header]));
        });
        numericalHeaders.push(OPS_COLUMN_NAME); 

        maxValues = {};
        numericalHeaders.forEach(header => {
            let maxVal = -Infinity;
            data.forEach(player => {
                const value = parseFloat(player[header]) || 0;
                if (value > maxVal) {
                    maxVal = value;
                }
            });
            maxValues[header] = maxVal > 0 ? maxVal : 0; 
        });
        
        return data;
    }

    // --- ( sortData å‡½æ•¸ ) ---
    function sortData() {
        allPlayerStats.sort((a, b) => {
            const aVal = a[sortColumn];
            const bVal = b[sortColumn];
            let comparison = 0;
            const isNumeric = !isNaN(parseFloat(aVal)) && !isNaN(parseFloat(bVal));

            if (isNumeric) {
                comparison = (parseFloat(aVal) || 0) - (parseFloat(bVal) || 0);
            } else {
                comparison = aVal.localeCompare(bVal, 'zh-TW', {sensitivity: 'base'});
            }

            return sortDirection === 'asc' ? comparison : comparison * -1;
        });
        renderTable(allPlayerStats);
    }

    // --- ( renderTable å‡½æ•¸ ) ---
    function renderTable(data) {
        const tableBody = document.getElementById('stats-table-body');

        if (data.length === 0 || Object.keys(data[0]).length < 5) {
            tableBody.innerHTML = `<tr><td colspan="100" class="text-danger text-center alert alert-danger">
                <strong>æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼š</strong> è¼‰å…¥çš„æ•¸æ“šç‚ºç©ºæˆ–æ¬„ä½æ•¸é‡ä¸è¶³ã€‚
            </td></tr>`;
            return;
        }

        let headers = Object.keys(data[0]);
        headers = headers.filter(h => !FROZEN_COLUMNS.includes(h) && h !== OPS_COLUMN_NAME); 
        
        const obpIndex = headers.indexOf(OBP_COLUMN);
        if (obpIndex !== -1) {
            headers.splice(headers.indexOf(SLG_COLUMN) + 1, 0, OPS_COLUMN_NAME);
        } else {
             headers.push(OPS_COLUMN_NAME); 
        }
        
        const finalHeaders = [...FROZEN_COLUMNS, ...headers];

        // 1. å‹•æ…‹ç”Ÿæˆè¡¨æ ¼æ¨™é ­
        document.querySelector('#stats-table thead tr').innerHTML = '';
        finalHeaders.forEach((header, index) => {
            const frozenIndex = FROZEN_COLUMNS.indexOf(header);
            const isFrozen = frozenIndex !== -1;
            const isSortable = !isFrozen || header === NAME_COLUMN || !isNaN(parseFloat(data[0][header])); 
            
            let thClass = isFrozen ? `sticky-col-${FROZEN_COLUMNS.indexOf(header) + 1}` : '';
            if (isSortable) { thClass += ' sortable'; }
            
            let sortIndicator = '';
            if (header === sortColumn) {
                sortIndicator = sortDirection === 'asc' ? ' â–¼' : ' â–²';
            }

            const th = document.createElement('th');
            th.scope = 'col';
            th.className = thClass;
            th.textContent = header + sortIndicator;
            th.setAttribute('data-column', header);

            if (isSortable) {
                 th.addEventListener('click', () => {
                    if (sortColumn === header) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = header;
                        sortDirection = 'asc';
                    }
                    sortData();
                });
            }
            document.querySelector('#stats-table thead tr').appendChild(th);
        });

        // 2. å‹•æ…‹ç”Ÿæˆè¡¨æ ¼å…§å®¹
        let tableRowsHTML = '';
        data.forEach(player => {
            let rowHTML = `<tr>`;
            
            // æª¢æŸ¥è©²çƒå“¡æ˜¯å¦åœ¨ä»»ä½•ä¸€å€‹æ•¸å€¼æ¬„ä½æ˜¯æœ€é«˜åˆ† (ç”¨æ–¼ç…§ç‰‡é«˜äº®)
            let isBestPlayerOverall = false;
            for (const header in maxValues) {
                if (maxValues.hasOwnProperty(header) && parseFloat(player[header]) === maxValues[header] && maxValues[header] !== 0) {
                    isBestPlayerOverall = true;
                    break;
                }
            }

            finalHeaders.forEach((header, index) => {
                const frozenIndex = FROZEN_COLUMNS.indexOf(header);
                const isFrozen = frozenIndex !== -1;
                let tdClass = isFrozen ? `sticky-col-${frozenIndex + 1}` : '';
                let cellContent = player[header] || '';

                if (header === PHOTO_URL_COLUMN) {
                    // **ç…§ç‰‡é«˜äº®é‚è¼¯**
                    const photoUrl = player[header] || 'https://via.placeholder.com/50?text=No+Photo'; 
                    let photoClass = 'player-photo';
                    if (isBestPlayerOverall) {
                        photoClass += ' best-player-photo'; // æ·»åŠ é«˜äº®é‚Šæ¡†é¡åˆ¥
                    }
                    cellContent = `<img src="${photoUrl}" onerror="this.src='https://via.placeholder.com/50?text=404'" alt="${player[NAME_COLUMN]}" class="${photoClass}">`;
                } else if (header === NAME_COLUMN) {
                    cellContent = `<span class="player-name-link" data-bs-toggle="modal" data-bs-target="#playerModal" data-player-name="${player[NAME_COLUMN]}">${player[NAME_COLUMN]}</span>`;
                }

                // å„²å­˜æ ¼é«˜äº®é‚è¼¯ 
                if (maxValues.hasOwnProperty(header)) {
                    const value = parseFloat(player[header]);
                    if (value === maxValues[header] && maxValues[header] !== 0) {
                        tdClass += ' highlight';
                    }
                }
                
                rowHTML += `<td class="${tdClass}">${cellContent}</td>`;
            });
            
            rowHTML += `</tr>`;
            tableRowsHTML += rowHTML;
        });

        tableBody.innerHTML = tableRowsHTML;
    }

    // --- ( Modal å‡½æ•¸ ) ---
    const playerModal = new bootstrap.Modal(document.getElementById('playerModal'));
    playerModal._element.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget; 
        const playerName = button.getAttribute('data-player-name');
        const playerDetails = allPlayerStats.find(p => p[NAME_COLUMN] === playerName);

        if (playerDetails) {
            document.getElementById('modalPlayerName').textContent = playerDetails[NAME_COLUMN];
            document.getElementById('playerModalLabel').textContent = `${playerDetails[NAME_COLUMN]} - è©³ç´°æ•¸æ“šåˆ†æ`;
            
            const modalPhotoUrl = playerDetails[PHOTO_URL_COLUMN] || 'https://via.placeholder.com/250?text=No+Photo';
            document.getElementById('modalPlayerPhoto').src = modalPhotoUrl;
            document.getElementById('modalPlayerPhoto').onerror = function() { this.src = 'https://via.placeholder.com/250?text=404+Error'; };
            
            const modalStatsBody = document.getElementById('modalPlayerStats');
            let statsHTML = '';
            const headers = Object.keys(playerDetails);

            headers.forEach(header => {
                if (!FROZEN_COLUMNS.includes(header)) {
                    statsHTML += `<div class="col-6 mb-2"><strong>${header}:</strong> ${playerDetails[header]}</div>`;
                }
            });
            modalStatsBody.innerHTML = statsHTML;
        }
    });

    // --- ä¸»ç¨‹å¼ï¼šè¼‰å…¥ä¸¦è™•ç†æ•¸æ“š (ä½¿ç”¨ PapaParse) ---
    Papa.parse(CSV_URL, {
        download: true,       
        header: true,         
        skipEmptyLines: true, 
        complete: function(results) {
            if (results.data && results.data.length > 0 && Object.keys(results.data[0]).length >= 5) {
                allPlayerStats = results.data.filter(row => row[NAME_COLUMN]); 
                allPlayerStats = processData(allPlayerStats); 
                sortData(); 
            } else {
                document.getElementById('stats-table-body').innerHTML = `<tr><td colspan="100" class="text-danger text-center alert alert-danger">
                    <strong>æ•¸æ“šè¼‰å…¥å¤±æ•— (PapaParse)ï¼š</strong> å–å¾—è³‡æ–™ç‚ºç©ºæˆ–æ ¼å¼éŒ¯èª¤ã€‚
                </td></tr>`;
            }
        },
        error: function(error) {
            console.error('æ•¸æ“šè™•ç†éŒ¯èª¤ (PapaParse):', error);
            document.getElementById('stats-table-body').innerHTML = `<tr><td colspan="100" class="text-danger text-center alert alert-danger">
                <strong>æ•¸æ“šè¼‰å…¥ç™¼ç”Ÿåš´é‡éŒ¯èª¤ (PapaParse)ï¼š</strong> ${error.message} <br>
                **è«‹ç¢ºèª Google Sheet çš„å…±ç”¨æ¬Šé™ç‚ºã€ŒçŸ¥é“é€£çµçš„ä½¿ç”¨è€…çš†å¯æª¢è¦–ã€ã€‚**
            </td></tr>`;
        }
    });
</script>

</body>
</html>